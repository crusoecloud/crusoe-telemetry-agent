services:
  crusoe-dcgm-exporter:
    image: nvidia/dcgm-exporter:4.3.1-4.4.0-ubuntu22.04
    container_name: crusoe-dcgm-exporter
    hostname: crusoe-dcgm-exporter
    cap_add: [SYS_ADMIN]
    volumes:
      - /etc/crusoe/telemetry_agent/dcp-metrics-included.csv:/etc/dcgm-exporter/dcp-metrics-included.csv:ro
    command: -f /etc/dcgm-exporter/dcp-metrics-included.csv
    privileged: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    network_mode: host

  crusoe-vector:
    image: timberio/vector:0.46.1-debian
    container_name: crusoe-vector
    hostname: crusoe-vector
    volumes:
      - /etc/crusoe/telemetry_agent/vector.yaml:/etc/vector/vector.yaml:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    env_file:
      - ./.env
    environment:
      - PROCFS_ROOT=/host/proc
      - SYSFS_ROOT=/host/sys
    depends_on:
      - crusoe-dcgm-exporter
    privileged: true
    entrypoint: /bin/sh -c "sleep 5 && /usr/bin/vector --config /etc/vector/vector.yaml"
    network_mode: host
